{
    "collab_server" : "",
    "contents" : "source(\"requirements.R\")\n# Load Data -------------------------------------------------------------------\n\nFY17_hires <- load_fy17_hire_data()\nworkflow_data <- load_workflow_data()\nofccp_data <- load_compliance_data()\n\nus_depts <- \n  c(\"Administration & Facilities Management\",\n    \"Finance and Compliance\",\n    \"Global Engagment and Policy\",\n    \"Global Partnership & Alliances\",\n    \"Information Technology\",\n    \"Internships\",\n    \"Mercy Corps Northwest\",\n    \"Middle East\",\n    \"PALM & Infrastructure and Project Management\",\n    \"People and Strategy\",\n    \"Program Operations & Regional Program Team\",\n    \"Resource Development\",\n    \"Strategic Response & Global Emergencies\",\n    \"Technical Support Unit\")\n\nstages_to_keep <- \n  c(\"New\",\n    \"Hiring Manager Review\",\n    \"Initial Interview\",\n    \"Follow Up Interviews\",\n    \"Offer Accepted\")\n\ndept_workflow_data <- function(data, department, years_hires) {\n  \n  dept_hires <- \n    years_hires %>% \n    filter(Department == department &\n             job_jobtype_name %in% c(\"Full-Time\",\"Part-Time\",\"Temp\"))\n  \n  dept_req_ids <- \n    dept_hires %>% \n    pull(Requisition_ID)\n  \n  merged_with_ofccp <- \n    data %>% \n    filter(job_requisition_id %in% dept_req_ids) %>% \n    left_join(ofccp_data %>% \n                select(compliance_preoffer_race,\n                       compliance_preoffer_gender,\n                       app_id,\n                       app_first_name),\n              by = c(\"app_id\" = \"app_id\"))\n  \n  first_names <- function(data) {\n    data %>%\n      pull(app_first_name) %>% \n      unique()\n  }\n  \n  name_gender_table <- \n    gender(first_names(merged_with_ofccp), years = c(1932,1999))\n  \n  name_gender_table$gender <- \n    recode(name_gender_table$gender,\n           'male' = 'male guessed',\n           'female' = 'female guessed')\n  \n  dept_merged_gender <- \n    merged_with_ofccp %>% \n    left_join(name_gender_table %>%\n                rename(guess_gender = gender) %>% \n                select(name, guess_gender),\n                by = c(\"app_first_name\" = \"name\")) %>% \n    mutate(calculated_gender = if_else(is.na(compliance_preoffer_gender),\n                                       tolower(guess_gender),\n                                       tolower(compliance_preoffer_gender)))\n  \n  dept_merged_gender\n}\n\n#' Group by a department\n#' \n#' @param df A tibble\n#' @param group_by Column to group by\n#' @param stages_to_kep What stages you'll be looking at\n#' @param na.rm Delete all rows with an NA in group_by\n#' @return A tibble with the df grouped by app_next_workflow_state_name and group_by\ndepartment_group <- function(df, group_by,stages_to_keep,na.rm = TRUE) {\n  \n  group_by <- enquo(group_by)\n  \n  df %>% \n    filter(app_next_workflow_state_name %in% stages_to_keep) %>% \n    {if(na.rm) filter(.,!is.na(!!group_by)) else .} %>%\n    distinct(app_id,app_next_workflow_state_name,.keep_all = TRUE) %>% \n    group_by(app_next_workflow_state_name,\n             !!group_by) %>% \n    summarize(n = n()) %>% \n    group_by(app_next_workflow_state_name) %>% \n    mutate(freq = round(n/sum(n),4))\n  \n}\n\nstages_plot <- function(df, fill_var,title = \"BLAHBLAH\") {\n  \n  fill_var <- enquo(fill_var)\n  fill_varN <- quo_name(fill_var)\n  \n  df %>% \n    ggplot(aes(x = app_next_workflow_state_name,\n               y = n)) +\n    geom_bar(aes_string(fill = fill_varN),\n             stat = \"identity\",\n             position = \"fill\") +\n    theme_few() +\n    rotate_x_text(45) +\n    labs(x = \"Workflow Stage\",\n         y = \"Percentage\",\n         fill = \"Gender\",\n         title = title) +\n    scale_fill_manual(values = c(\"#ffffbf\",\"#d7191c\",\"#fdae61\",\"#2c7bb6\",\"#abd9e9\",\"black\"))\n}\n\n\ndept_to_analyze <- \"Technical Support Unit\"\n\n\nworkflow_data %>% \n  dept_workflow_data(dept_to_analyze,FY17_hires) %>% \n  department_group(calculated_gender,stages_to_keep) %>% \n  stages_plot(calculated_gender,\n              title = paste(dept_to_analyze,\"gender by workflow stage\"))\n\nfor(dept in us_depts) {\n  \n  dir.create(paste0(\"Reports/\",dept),\n             showWarnings = FALSE)\n  \n  fields <- c(quo(calculated_gender),\n              quo(compliance_preoffer_race))\n  \n  for(f in fields) {\n    workflow_data %>% \n      dept_workflow_data(dept_to_analyze,FY17_hires) %>% \n      department_group(!!f,stages_to_keep) %>% \n      stages_plot(!!f,\n                  title = paste(dept_to_analyze,\"by workflow stage\"))\n    \n    ggsave(paste0(\"Reports/\",dept,\"/\",dept,\" plot.png\"),\n           plot = last_plot(),\n           dpi = 150,\n           width = 8,\n           height = 6,\n           units = \"in\") \n    \n  }\n}\n",
    "created" : 1508176505478.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "718886699",
    "id" : "DD995652",
    "lastKnownWriteTime" : 1502936358,
    "last_content_update" : 1502936358,
    "path" : "~/R/Samcode/generic department.R",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 4,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}